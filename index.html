<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spend Guard Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
.app-logo{background-image:url('logo.png');background-size:cover;width:80px;height:80px;border-radius:22px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center}
.modal.active{display:flex}
.budget-card{background:#0f172a;border-radius:2.5rem;padding:1.75rem;border-left:6px solid #3b82f6}
</style>
</head>

<body class="bg-gray-50">

<!-- CATEGORY MANAGER -->
<div id="manageModal" class="modal">
<div class="bg-white max-w-sm w-full rounded-[2.5rem] p-8">
<h3 class="font-black mb-4">Manage Categories</h3>
<input id="catSearch" oninput="renderManageList()" class="w-full p-3 bg-gray-100 rounded-xl mb-3">
<div id="catList"></div>
<button onclick="closeModal()" class="mt-4 w-full bg-slate-900 text-white p-3 rounded-xl">Close</button>
</div>
</div>

<!-- BUDGET MODAL -->
<div id="budgetModal" class="modal">
<div class="bg-white max-w-sm w-full rounded-[2.5rem] p-8">
<h3 class="font-black mb-4">Category Budgets</h3>
<div id="budgetList" class="space-y-3 max-h-72 overflow-y-auto"></div>
<button onclick="closeBudgetModal()" class="mt-4 w-full bg-slate-900 text-white p-3 rounded-xl">Close</button>
</div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="min-h-screen flex items-center justify-center hidden">
<button onclick="handleLogin()" class="bg-slate-900 text-white p-6 rounded-xl">
Sign in with Google
</button>
</div>

<!-- APP -->
<div id="appPage" class="max-w-md mx-auto p-4 hidden">

<div class="budget-card text-white mb-6">
<h2 id="monthlyTotal" class="text-4xl font-black">â‚¹0</h2>
<p id="compareText"></p>
<div class="h-2 bg-slate-700 mt-4 rounded">
<div id="progressBar" class="h-full bg-blue-500"></div>
</div>
</div>

<div class="grid grid-cols-3 gap-2 mb-6">
<button onclick="handleAddCategory()" class="bg-white p-3 rounded-xl">âž• Category</button>
<button onclick="openModal()" class="bg-white p-3 rounded-xl">ðŸ—‘ Manage</button>
<button onclick="openBudgetModal()" class="bg-white p-3 rounded-xl">ðŸ“Š Budgets</button>
</div>

<div class="bg-white p-6 rounded-xl mb-6">
<input id="amount" placeholder="Amount" class="w-full mb-2 p-3 bg-gray-100 rounded">
<select id="sector" class="w-full p-3 bg-gray-100 rounded"></select>
<button onclick="handleSaveExpense()" class="mt-3 w-full bg-blue-600 text-white p-4 rounded-xl">
Add Expense
</button>
</div>

<div id="history"></div>

</div>

<script>

/* FIREBASE */
firebase.initializeApp({
apiKey:"AIzaSyBSfbUpYpgu0kLC2a1I4oEiQjH_zQoxcdE",
authDomain:"expensetracker-7da2d.firebaseapp.com",
projectId:"expensetracker-7da2d"
});

const db=firebase.firestore(),auth=firebase.auth();

/* GLOBAL */
let categories=[];
let categoryBudgets={};
let monthlySalary=32000;
let allExpenses=[],filteredExpenses=[],activeCatData={};

/* AUTH */
auth.onAuthStateChanged(user=>{
if(user){
loginPage.classList.add("hidden");
appPage.classList.remove("hidden");

db.collection("user_settings").doc(user.uid)
.onSnapshot(doc=>{
if(doc.exists){
let d=doc.data();
categories=d.categories||["ðŸ” Food","ðŸš— Travel","ðŸ› Shopping","Bills"];
categoryBudgets=d.categoryBudgets||{};
monthlySalary=d.salary||32000;
}else saveSettingsToCloud();

renderAll();
});

db.collection("expenses")
.where("uid","==",user.uid)
.onSnapshot(s=>{
allExpenses=s.docs.map(d=>({id:d.id,...d.data()}));
renderAll();
});
}
});

/* CLOUD SAVE */
function saveSettingsToCloud(){
db.collection("user_settings")
.doc(auth.currentUser.uid)
.set({
categories,
salary:monthlySalary,
categoryBudgets
},{merge:true});
}

/* CATEGORY */
function handleAddCategory(){
let n=prompt("New Category");
if(!n)return;
categories.push(n);
saveSettingsToCloud();
renderAll();
}

function removeCat(c){
categories=categories.filter(x=>x!==c);
delete categoryBudgets[c];
saveSettingsToCloud();
renderAll();
renderManageList();
}

/* MODALS */
function openModal(){manageModal.classList.add("active");renderManageList();}
function closeModal(){manageModal.classList.remove("active");}

function openBudgetModal(){
budgetModal.classList.add("active");
renderBudgetList();
}
function closeBudgetModal(){budgetModal.classList.remove("active");}

/* BUDGET UI */
function renderBudgetList(){
budgetList.innerHTML=categories.map(c=>`
<div class="flex justify-between bg-gray-100 p-3 rounded">
<span>${c}</span>
<input type="number" value="${categoryBudgets[c]||""}"
oninput="updateCategoryBudget('${c}',this.value)"
class="w-28 p-2 rounded"/>
</div>`).join("");
}

function updateCategoryBudget(c,v){
if(!v)delete categoryBudgets[c];
else categoryBudgets[c]=parseFloat(v);
saveSettingsToCloud();
}

/* SAVE EXPENSE */
function handleSaveExpense(){
db.collection("expenses").add({
amount:+amount.value,
sector:sector.value,
uid:auth.currentUser.uid,
date:new Date().toISOString().slice(0,10)
});
amount.value="";
}

/* RENDER */
function renderAll(){

sector.innerHTML=categories.map(c=>`<option>${c}</option>`).join("");

activeCatData={};
filteredExpenses=allExpenses;

filteredExpenses.forEach(e=>{
activeCatData[e.sector]=(activeCatData[e.sector]||0)+e.amount;
});

monthlyTotal.innerText="â‚¹"+Object.values(activeCatData).reduce((a,b)=>a+b,0);

history.innerHTML=filteredExpenses.map(e=>`
<div class="bg-white p-4 rounded mb-2 flex justify-between">
<p class="${
categoryBudgets[e.sector] &&
activeCatData[e.sector]>categoryBudgets[e.sector]
?"text-red-600":""
}">${e.sector}</p>
<p>â‚¹${e.amount}</p>
</div>`).join("");

}

/* LOGIN */
function handleLogin(){
auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

</script>
</body>
</html>
