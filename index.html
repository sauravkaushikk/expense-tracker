<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spend Guard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBSfbUpYpgu0kLC2a1I4oEiQjH_zQoxcdE",
            authDomain: "expensetracker-7da2d.firebaseapp.com",
            projectId: "expensetracker-7da2d",
            storageBucket: "expensetracker-7da2d.firebasestorage.app",
            messagingSenderId: "765154907153",
            appId: "1:765154907153:web:089afc8966a991c9524db0",
            measurementId: "G-8TBNNT0ZWK"
        };


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();


        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);


        onAuthStateChanged(auth, (user) => {
            const loginPage = document.getElementById('loginPage');
            const appPage = document.getElementById('appPage');
            if (user) {
                window.currentUser = user;
                loginPage.classList.add('hidden');
                appPage.classList.remove('hidden');
                document.getElementById('userName').innerText = user.displayName;
                syncData();
            } else {
                loginPage.classList.remove('hidden');
                appPage.classList.add('hidden');
            }
        });


        async function syncData() {
            const q = query(collection(db, "expenses"), where("uid", "==", window.currentUser.uid), orderBy("date", "desc"));
            onSnapshot(q, (snapshot) => {
                window.expenses = snapshot.docs.map(doc => doc.data());
                window.render();
            });
        }


        window.saveToCloud = async (data) => {
            await addDoc(collection(db, "expenses"), { ...data, uid: window.currentUser.uid });
        };
    </script>
</head>
<body class="bg-gray-50 text-slate-800 pb-24">


    <div id="loginPage" class="flex flex-col items-center justify-center min-h-screen p-6">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm">
            <h1 class="text-3xl font-bold mb-4">Spend Guard</h1>
            <p class="text-gray-400 mb-8">Minimalist tracking, Cloud secure.</p>
            <button onclick="login()" class="flex items-center justify-center gap-3 w-full bg-slate-900 text-white p-4 rounded-2xl font-bold">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa/google.svg" class="w-6"> Sign in with Google
            </button>
        </div>
    </div>


    <div id="appPage" class="hidden max-w-md mx-auto p-4">
        <div class="flex justify-between items-center mb-6 px-2">
            <p class="text-sm font-semibold">Hi, <span id="userName" class="text-blue-600">User</span></p>
            <button onclick="logout()" class="text-xs text-gray-400">Logout</button>
        </div>


        <div id="dashCard" class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl mb-6">
            <div class="flex justify-between items-start mb-2">
                <p id="periodLabel" class="text-slate-400 text-xs uppercase tracking-widest">Today's Spend</p>
                <button onclick="setSalary()" class="text-[10px] bg-slate-800 px-2 py-1 rounded-lg">Set Salary</button>
            </div>
            <h2 id="monthlyTotal" class="text-4xl font-bold mb-4">₹0</h2>
            <div class="mb-4">
                <div class="flex justify-between text-[10px] mb-1 text-slate-400 uppercase">
                    <span>Budget Usage</span>
                    <span id="budgetPercent">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex justify-between border-t border-slate-700 pt-4">
                <div><p class="text-[10px] text-slate-400 uppercase">Daily Limit</p><p id="limitDisplay" class="text-lg font-semibold">₹500</p></div>
                <div class="text-right"><p class="text-[10px] text-slate-400 uppercase">Salary</p><p id="salaryDisplay" class="text-lg font-semibold">₹0</p></div>
            </div>
        </div>


        <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-6">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input id="amount" type="number" placeholder="₹ Amount" class="p-3 rounded-xl bg-gray-100 outline-none">
                <div class="flex gap-1">
                    <select id="sector" onchange="toggleSubSector()" class="flex-grow p-3 rounded-xl bg-gray-100 outline-none text-sm"></select>
                    <button onclick="addCustomCategory()" class="bg-blue-600 text-white px-3 rounded-xl">+</button>
                </div>
            </div>
            <div id="subSectorContainer" class="hidden mb-3">
                <select id="subSector" class="w-full p-3 rounded-xl bg-blue-50 border border-blue-100 outline-none text-sm">
                    <option value="📱 Mobile Recharge">📱 Mobile Recharge</option>
                    <option value="🌐 Fiber Bill">🌐 Fiber Bill</option>
                    <option value="💳 Credit Card">💳 Credit Card</option>
                </select>
            </div>
            <div class="flex gap-3 mb-3">
                <select id="method" class="w-1/2 p-3 rounded-xl bg-gray-100 outline-none"><option>UPI</option><option>Cash</option></select>
                <input id="date" type="date" class="w-1/2 p-3 rounded-xl bg-gray-100 outline-none">
            </div>
            <button onclick="saveExpense()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-blue-100">Add Expense</button>
        </div>


        <div class="bg-white p-4 rounded-3xl border border-gray-100 mb-6">
            <div class="grid grid-cols-2 gap-2 mb-3">
                <input id="startDate" type="date" oninput="render()" class="p-2 rounded-lg bg-gray-50 border text-xs outline-none">
                <input id="endDate" type="date" oninput="render()" class="p-2 rounded-lg bg-gray-50 border text-xs outline-none">
            </div>
            <input id="searchInput" oninput="render()" type="text" placeholder="🔍 Search transactions..." class="w-full p-3 rounded-xl bg-gray-50 border outline-none text-sm">
        </div>


        <div id="chartSection" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-6 hidden">
            <div class="h-64 mb-4"><canvas id="expenseChart"></canvas></div>
            <div id="breakdownList" class="space-y-2"></div>
        </div>


        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="exportExcel()" class="bg-green-100 text-green-700 p-3 rounded-xl text-xs font-bold">📊 Excel</button>
            <button onclick="exportPDF()" class="bg-red-100 text-red-700 p-3 rounded-xl text-xs font-bold">📄 PDF</button>
        </div>


        <div id="history" class="space-y-3"></div>
    </div>


    <script>
        let expenses = [];
        let dailyLimit = localStorage.getItem('myLimit') || 500;
        let monthlySalary = localStorage.getItem('mySalary') || 50000;
        let categories = JSON.parse(localStorage.getItem('myCats')) || ["🍔 Food", "🚗 Travel", "🛍️ Shopping", "🧾 Bills", "📺 OTT Subscription", "📦 Others"];
        let myChart = null;


        function init() {
            document.getElementById('sector').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('salaryDisplay').innerText = `₹${monthlySalary}`;
        }


        function toggleSubSector() {
            document.getElementById('subSectorContainer').classList.toggle('hidden', document.getElementById('sector').value !== "🧾 Bills");
        }


        async function saveExpense() {
            const amount = parseFloat(document.getElementById('amount').value);
            let sector = document.getElementById('sector').value;
            if(sector === "🧾 Bills") sector = `🧾 Bill: ${document.getElementById('subSector').value}`;
            const data = { amount, sector, method: document.getElementById('method').value, date: document.getElementById('date').value };
            if(!data.amount || !data.date) return;
            await window.saveToCloud(data);
            document.getElementById('amount').value = '';
        }


        function render() {
            const today = new Date().toISOString().split('T')[0];
            const startD = document.getElementById('startDate').value;
            const endD = document.getElementById('endDate').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let dSum = 0, filteredSum = 0, sMap = {};


            const filtered = expenses.filter(ex => {
                const matchesDate = (!startD || ex.date >= startD) && (!endD || ex.date <= endD);
                const matchesSearch = ex.sector.toLowerCase().includes(search);
                if(ex.date === today) dSum += ex.amount;
                return matchesDate && matchesSearch;
            });


            document.getElementById('history').innerHTML = filtered.map(ex => {
                filteredSum += ex.amount;
                sMap[ex.sector] = (sMap[ex.sector] || 0) + ex.amount;
                return `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-100">
                    <div><p class="font-bold text-sm">${ex.sector}</p><p class="text-[10px] text-gray-400">${ex.date}</p></div>
                    <p class="font-bold">₹${ex.amount}</p>
                </div>`;
            }).join('');


            updateUI(dSum, filteredSum, sMap);
        }


        function updateUI(dSum, fSum, sMap) {
            document.getElementById('dailyTotal').innerText = `₹${dSum}`;
            document.getElementById('monthlyTotal').innerText = `₹${fSum}`;
            document.getElementById('limitDisplay').innerText = `₹${dailyLimit}`;
            
            const pc = Math.min((fSum/monthlySalary)*100, 100).toFixed(1);
            document.getElementById('budgetPercent').innerText = `${pc}%`;
            const bar = document.getElementById('progressBar');
            bar.style.width = `${pc}%`;
            bar.className = pc > 90 ? "bg-red-500 h-full transition-all" : pc > 70 ? "bg-orange-500 h-full transition-all" : "bg-blue-500 h-full transition-all";


            const chartSec = document.getElementById('chartSection');
            if(fSum > 0) {
                chartSec.classList.remove('hidden');
                updateChart(sMap);
            } else chartSec.classList.add('hidden');
        }


        function updateChart(sMap) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(sMap), datasets: [{ data: Object.values(sMap), backgroundColor: ['#2563eb', '#7c3aed', '#db2777', '#ea580c', '#16a34a', '#4b5563'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });
        }


        const stripEmojis = (str) => str.replace(/[\u1000-\uFFFF]+/g, '').replace(/[^\x00-\x7F]/g, "").trim();
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Expense Report", 14, 20);
            doc.autoTable({ head: [['Date', 'Category', 'Amount']], body: expenses.map(e => [e.date, stripEmojis(e.sector), e.amount]), startY: 30 });
            doc.save("Report.pdf");
        }


        function setSalary() {
            const s = prompt("Monthly Salary:", monthlySalary);
            if(s) { monthlySalary = s; localStorage.setItem('mySalary', s); render(); }
        }


        init();
    </script>
</body>
</html>