<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spend Guard Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
.app-logo { background-image:url('logo.png');background-size:cover;width:80px;height:80px;border-radius:22px }
.custom-scroll::-webkit-scrollbar{display:none}
.budget-card{background:#0f172a;border-radius:2.5rem;padding:1.75rem;border-left:6px solid #3b82f6}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center}
.modal.active{display:flex}
</style>
</head>

<body class="bg-gray-50 text-slate-800 pb-20 custom-scroll">

<!-- MANAGE CATEGORIES -->
<div id="manageModal" class="modal">
<div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
<h3 class="text-xl font-black mb-4">Manage Categories</h3>
<input id="catSearch" oninput="renderManageList()" class="w-full p-4 bg-gray-100 rounded-2xl mb-4">
<div id="catList" class="space-y-2"></div>
<button onclick="closeModal()" class="w-full p-4 bg-slate-900 text-white rounded-2xl font-bold uppercase text-xs">Close</button>
</div>
</div>

<!-- CATEGORY BUDGET MODAL -->
<div id="budgetModal" class="modal">
<div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
<h3 class="text-xl font-black mb-4">Category Budgets</h3>
<div id="budgetList" class="space-y-3 max-h-72 overflow-y-auto custom-scroll"></div>
<button onclick="closeBudgetModal()" class="w-full p-4 bg-slate-900 text-white rounded-2xl font-bold uppercase text-xs mt-4">Close</button>
</div>
</div>

<!-- LOGIN -->
<div id="loginPage" class="flex flex-col items-center justify-center min-h-screen p-6 hidden">
<div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm">
<h1 class="text-3xl font-bold mb-1">Spend Guard</h1>
<p class="text-gray-400 mb-8 text-sm">Minimalist tracking, Cloud secure.</p>
<button onclick="handleLogin()" class="bg-slate-900 text-white p-4 rounded-2xl font-bold">
Sign in with Google
</button>
</div>
</div>

<!-- APP -->
<div id="appPage" class="max-w-md mx-auto p-4 hidden">

<div class="budget-card text-white mb-6">
<h2 id="monthlyTotal" class="text-5xl font-black mb-4">â‚¹0</h2>
<p id="compareText" class="text-xs"></p>
<div class="h-2 bg-slate-800 rounded-full overflow-hidden">
<div id="progressBar" class="h-full bg-blue-500"></div>
</div>
</div>

<div class="grid grid-cols-3 gap-3 mb-6">
<button onclick="handleAddCategory()" class="bg-white border p-4 rounded-2xl">â• Add</button>
<button onclick="openModal()" class="bg-white border p-4 rounded-2xl">ğŸ—‘ï¸ Manage</button>
<button onclick="openBudgetModal()" class="bg-white border p-4 rounded-2xl">ğŸ“Š Budgets</button>
</div>

<div id="history"></div>

</div>

<script>

firebase.initializeApp({
apiKey:"AIzaSyBSfbUpYpgu0kLC2a1I4oEiQjH_zQoxcdE",
authDomain:"expensetracker-7da2d.firebaseapp.com",
projectId:"expensetracker-7da2d"
});

const db=firebase.firestore(),auth=firebase.auth();

/* GLOBAL */
let categories=[];
let monthlySalary=32000;
let allExpenses=[],filteredExpenses=[],categoryChart=null,isSeeAll=false,globalFilteredSum=0,activeCatData={};
let categoryBudgets={};

/* AUTH */
auth.onAuthStateChanged(user=>{
if(user){

document.getElementById("loginPage").classList.add("hidden");
document.getElementById("appPage").classList.remove("hidden");

db.collection("user_settings").doc(user.uid)
.onSnapshot(doc=>{
if(doc.exists){
const d=doc.data();

if(d.categories) categories=d.categories;
if(d.salary) monthlySalary=d.salary;
if(d.categoryBudgets) categoryBudgets=d.categoryBudgets;

}else saveSettingsToCloud();

handleRender();
});

db.collection("expenses")
.where("uid","==",user.uid)
.onSnapshot(s=>{
allExpenses=s.docs.map(d=>({id:d.id,...d.data()}));
handleRender();
});

}else{
document.getElementById("loginPage").classList.remove("hidden");
}
});

/* CLOUD SAVE */
function saveSettingsToCloud(){
if(auth.currentUser){
db.collection("user_settings").doc(auth.currentUser.uid).set({
categories,
salary:monthlySalary,
categoryBudgets
},{merge:true});
}
}

/* CATEGORY */
function handleAddCategory(){
let n=prompt("New Category:");
if(!n)return;
categories.push(n.trim());
saveSettingsToCloud();
handleRender();
}

/* MODALS */
function openModal(){document.getElementById("manageModal").classList.add("active");renderManageList();}
function closeModal(){document.getElementById("manageModal").classList.remove("active");}

function openBudgetModal(){
document.getElementById("budgetModal").classList.add("active");
renderBudgetList();
}
function closeBudgetModal(){
document.getElementById("budgetModal").classList.remove("active");
}

/* BUDGET UI */
function renderBudgetList(){
document.getElementById("budgetList").innerHTML=
categories.map(cat=>`
<div class="flex justify-between bg-gray-50 p-4 rounded-xl">
<span class="font-bold">${cat}</span>
<input type="number"
value="${categoryBudgets[cat]||""}"
placeholder="â‚¹ Limit"
oninput="updateCategoryBudget('${cat}',this.value)"
class="w-28 p-2 rounded-lg bg-white border"/>
</div>`).join("");
}

function updateCategoryBudget(cat,val){
if(!val) delete categoryBudgets[cat];
else categoryBudgets[cat]=parseFloat(val);
saveSettingsToCloud();
}

/* REMOVE CAT PATCH */
function removeCat(c){
if(confirm("Delete?")){
categories=categories.filter(i=>i!==c);
delete categoryBudgets[c];
saveSettingsToCloud();
renderManageList();
handleRender();
}
}

/* HISTORY RENDER PATCH */
function handleRender(){

document.getElementById("history").innerHTML=filteredExpenses.map(ex=>`
<div class="bg-white p-4 rounded-2xl flex justify-between border mb-2">
<p class="font-bold ${
categoryBudgets[ex.sector] &&
activeCatData[ex.sector]>categoryBudgets[ex.sector]
?"text-red-600":"text-slate-700"
}">${ex.sector}</p>
<p>â‚¹${ex.amount}</p>
</div>`).join("");

}

/* LOGIN */
function handleLogin(){
auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

</script>
</body>
</html>
